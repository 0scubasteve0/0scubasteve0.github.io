---
layout: single
title:  "Setting up a ZFS-backed KVM Hypervisor on Ubuntu 18.04"
date:   2019-03-28 22:45:00
categories: [Linux Administration]
tags: linux kvm zfs virtualization vm ubuntu
comments: true
---

Regardless of your environtment and your server requirements, the hypervisor is the foundational component that makes it all work. The ability to run several virtual servers in a single physical box is what makes it possible for businesses of all sizes to run complex applications with minimal cost and power usage. It's also what enables people like me to learn and practice Linux administration in a one-bedroom Brooklyn apartment.  

In this tutorial, we're going to setting up our virtual environment with KVM/QEMU as the hypervisor and ZFS providing the storage for our VMs.

### The Tools

  * [Ubuntu 18.04 Server](https://www.ubuntu.com/download/server) - Our host OS, chosen due to its out-of-the-box support for the ZFS filesystem.
  *  [ZFS Filesystem](https://wiki.ubuntu.com/ZFS) - There are many on the web who can speak to the benefits of ZFS better than I can, but essentially ZFS is a ultra-reliable filesystem and logical volume manager with built-in software RAID, checksums, compression, and de-duplicaton. On top of that, it's very straightforward to configure and manage.
  *  [KVM/QEMU](https://www.linux-kvm.org/page/Main_Page) - Industry-standard, open-source, Linux-based VM hypervisor. Manageable from the CLI or any number of GUI applications (i.e. [virt-manager](https://virt-manager.org/))

### Sections in this Tutorial

 1. Install & Configure ZFS
 2. Install & Configure KVM/QEMU
 3. Create a VM
 4. Managing the hypervisor via CLI
 5. Managing the hypervisor via GUI (virt-manager)
 5. Concluding thoughts

### Step 1: Install & Configure ZFS

Below are the steps I used to configure a ZFS storage pool on my PowerEdge T30. On that system, I'm using (3) 4TB drives in a RAIDz1 array, allowing for one disk failure and providing more than adequate I/O performance. The RAID type you choose depends on a lot of factors, and I suggest you read one of the many articles about benefits/drawbacks of the different types ([Wikipedia](https://en.wikipedia.org/wiki/ZFS#RAID_(%22RaidZ%22))). For the purposes of this guide, I'll be using x3 4GB virtual disks in RAIDz1.

Update your repos and install the ZFS packages:  
``` bash
sudo apt update
```
``` bash
sudo apt install zfsutils-linux
```
\\
Assuming you didn't get an error message, ZFS should now be installed on your machine.  

Next, we need to get the names of the drives we're going to use:
``` bash
sudo fdisk -l
```
\\
You should see an output similar to this:
``` bash
Disk /dev/vda: 25 GiB, 26843545600 bytes, 52428800 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: 07BCD546-2A83-4F37-822F-C7E7B7B8811A

Device     Start      End  Sectors Size Type
/dev/vda1   2048     4095     2048   1M BIOS boot
/dev/vda2   4096 52426751 52422656  25G Linux filesystem


Disk /dev/vdb: 4 GiB, 4294967296 bytes, 8388608 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes


Disk /dev/vdc: 4 GiB, 4294967296 bytes, 8388608 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes


Disk /dev/vdd: 4 GiB, 4294967296 bytes, 8388608 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
```
\\
You can see above that `/dev/vda` is my OS drive and `/dev/vdb /dev/vdc /dev/vdd` are the disks we'll use for our ZFS RAID. Make note of these names.



